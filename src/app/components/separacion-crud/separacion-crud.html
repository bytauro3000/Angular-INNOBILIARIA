<div class="contenedor-separaciones">
  <h1 id="titPrin" class="mb-4">Gestión de Separaciones</h1>

  <!-- Filtros -->
  <div class="filtros row g-2 mb-2">
    <div class="col-sm-3">
      <input type="text" class="form-control form-control-sm" placeholder="Filtrar por manzana-lote..."
             [(ngModel)]="manzLote" (input)="filtrarSeparaciones()" />
    </div>

    <div class="col-sm-3">
      <input type="text" class="form-control form-control-sm" placeholder="Filtrar por DNI..."
             [(ngModel)]="dni" (input)="filtrarSeparaciones()" />
    </div>

    <div class="col-sm-3">
      <input type="text" class="form-control form-control-sm" placeholder="Filtrar por nombre/apellido..."
             [(ngModel)]="nomApe" (input)="filtrarSeparaciones()" />
    </div>

    <div class="col-sm-3">
      <select class="form-select form-select-sm" [(ngModel)]="filtroEstado" (change)="filtrarSeparaciones()">
        <option value="">Todos los estados</option>
        <option *ngFor="let estado of ['EN_PROCESO', 'CONCRETADO', 'FINALIZADO']" [value]="estado">
          {{ estado }}
        </option>
      </select>
    </div>
  </div>

  <!-- Botón Crear -->
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-success btn-sm" (click)="mostrarCrear()">
      <i class="bi bi-plus-lg"></i> Crear separación
    </button>
  </div>

  <!-- Tabla -->
  <div class="table-responsive shadow-sm rounded">
    <table class="table table-sm table-hover align-middle tabla-ajustada">
      <thead class="table-dark">
        <tr>
          <th>Id</th>
          <th>DNI</th>
          <th>Cliente</th>
          <th>Manzana-Lote</th>
          <th>Monto</th>
          <th>Fecha Separación</th>
          <th>Fecha Límite</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let separacion of paginasSeparaciones">
          <td>{{ separacion.idSeparacion }}</td>
          <td>{{ separacion.dni }}</td>
          <td>{{ separacion.nomApeCli }}</td>
          <td>{{ separacion.manLote }}</td>
          <td>{{ separacion.monto | currency:'PEN':'symbol':'1.0-0' }}</td>
          <td>{{ separacion.fechaSepara | date:'shortDate' }}</td>
          <td>{{ separacion.fechaLimite | date:'shortDate' }}</td>
          <td>
            <span class="badge"
                  [ngClass]="{
                    'bg-warning text-dark': separacion.estadoSeparacion === 'EN_PROCESO',
                    'bg-success': separacion.estadoSeparacion === 'CONCRETADO',
                    'bg-secondary': separacion.estadoSeparacion === 'FINALIZADO'
                  }">
              {{ separacion.estadoSeparacion }}
            </span>
          </td>
          <td>
            <button class="btn btn-outline-info btn-sm me-1" (click)="mostrarDetalle(separacion)">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-outline-primary btn-sm me-1" (click)="mostrarEditar(separacion)">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" (click)="mostrarEliminar(separacion)">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
<!-- Modal Detalle Separación -->
<div class="modal fade" id="modalDetalleSeparacion" tabindex="-1" aria-hidden="true"
     [ngClass]="{show: modalDetalleVisible}" style="display: block;" *ngIf="modalDetalleVisible">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle de Separación</h5>
        <button type="button" class="btn-close" (click)="cerrarModal()"></button>
      </div>

      <div class="modal-body small row g-3">
        <!-- Cliente -->
        <h6 class="text-primary">Datos del Cliente</h6>
        <p class="col-sm-4"><strong>Nombre:</strong> {{ separacionSeleccionada?.cliente?.nombre }} {{ separacionSeleccionada?.cliente?.apellidos }}</p>
        <p class="col-sm-4"><strong>DNI/RUC:</strong> {{ separacionSeleccionada?.cliente?.numDoc }}</p>
        <p class="col-sm-4"><strong>Tipo:</strong> {{ separacionSeleccionada?.cliente?.tipoCliente }}</p>
        <p class="col-sm-4"><strong>Celular:</strong> {{ separacionSeleccionada?.cliente?.celular }}</p>
        <p class="col-sm-4"><strong>Teléfono:</strong> {{ separacionSeleccionada?.cliente?.telefono }}</p>
        <p class="col-sm-4"><strong>Email:</strong> {{ separacionSeleccionada?.cliente?.email }}</p>
        <p class="col-sm-6"><strong>Dirección:</strong> {{ separacionSeleccionada?.cliente?.direccion }}</p>
        <p class="col-sm-6"><strong>Distrito:</strong> {{ separacionSeleccionada?.cliente?.distrito?.nombre }}</p>

        <!-- Vendedor -->
        <h6 class="text-success mt-3">Datos del Vendedor</h6>
        <p class="col-sm-4"><strong>Nombre:</strong> {{ separacionSeleccionada?.vendedor?.nombre }} {{ separacionSeleccionada?.vendedor?.apellidos }}</p>
        <p class="col-sm-4"><strong>DNI:</strong> {{ separacionSeleccionada?.vendedor?.dni }}</p>
        <p class="col-sm-4"><strong>Celular:</strong> {{ separacionSeleccionada?.vendedor?.celular }}</p>
        <p class="col-sm-4"><strong>Email:</strong> {{ separacionSeleccionada?.vendedor?.email }}</p>
        <p class="col-sm-4"><strong>Dirección:</strong> {{ separacionSeleccionada?.vendedor?.direccion }}</p>
        <p class="col-sm-4"><strong>Distrito:</strong> {{ separacionSeleccionada?.vendedor?.distrito?.nombre }}</p>

        <!-- Lote -->
        <h6 class="text-warning mt-3">Datos del Lote</h6>
        <p class="col-sm-3"><strong>Manzana:</strong> {{ separacionSeleccionada?.lote?.manzana }}</p>
        <p class="col-sm-3"><strong>N° Lote:</strong> {{ separacionSeleccionada?.lote?.numeroLote }}</p>
        <p class="col-sm-3"><strong>Área:</strong> {{ separacionSeleccionada?.lote?.area }} m²</p>
        <p class="col-sm-3"><strong>Precio/m²:</strong> S/. {{ separacionSeleccionada?.lote?.precioM2 }}</p>
        <p class="col-sm-6"><strong>Colindante Norte:</strong> {{ separacionSeleccionada?.lote?.colindanteNorte }}</p>
        <p class="col-sm-6"><strong>Colindante Sur:</strong> {{ separacionSeleccionada?.lote?.colindanteSur }}</p>
        <p class="col-sm-6"><strong>Colindante Este:</strong> {{ separacionSeleccionada?.lote?.colindanteEste }}</p>
        <p class="col-sm-6"><strong>Colindante Oeste:</strong> {{ separacionSeleccionada?.lote?.colindanteOeste }}</p>

        <!-- Programa -->
        <h6 class="text-secondary mt-3">Programa Asociado</h6>
        <p class="col-sm-6"><strong>Nombre:</strong> {{ separacionSeleccionada?.lote?.programa?.nombrePrograma }}</p>
        <p class="col-sm-6"><strong>Ubicación:</strong> {{ separacionSeleccionada?.lote?.programa?.ubicacion }}</p>
        <p class="col-sm-6"><strong>Distrito:</strong> {{ separacionSeleccionada?.lote?.programa?.distrito?.nombre }}</p>
        <p class="col-sm-6"><strong>Parcelero:</strong> {{ separacionSeleccionada?.lote?.programa?.parcelero?.nombres }} {{ separacionSeleccionada?.lote?.programa?.parcelero?.apellidos }}</p>

        <!-- Separación -->
        <h6 class="text-dark mt-3">Datos de Separación</h6>
        <p class="col-sm-4"><strong>Monto:</strong> S/. {{ separacionSeleccionada?.monto }}</p>
        <p class="col-sm-4"><strong>Fecha Separación:</strong> {{ separacionSeleccionada?.fechaSeparacion | date:'shortDate' }}</p>
        <p class="col-sm-4"><strong>Fecha Límite:</strong> {{ separacionSeleccionada?.fechaLimite | date:'shortDate' }}</p>
        <p class="col-sm-4"><strong>Estado:</strong> {{ separacionSeleccionada?.estado }}</p>
        <p class="col-sm-8"><strong>Observaciones:</strong> {{ separacionSeleccionada?.observaciones }}</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" (click)="cerrarModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<!-- 
<div class="modal fade" id="modalEliminarSeparacion" tabindex="-1" aria-hidden="true"
     [ngClass]="{show: modalEliminarVisible}" style="display: block;" *ngIf="modalEliminarVisible">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">¿Eliminar separación?</h5>
        <button type="button" class="btn-close" (click)="cerrarModal()"></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que deseas eliminar la separación del cliente
           <strong>{{ separacionSeleccionada?.cliente?.nombre }} {{ separacionSeleccionada?.cliente?.apellidos }}</strong>
           en el lote <strong>{{ separacionSeleccionada?.lote?.manzana }} - {{ separacionSeleccionada?.lote?.numeroLote }}</strong>?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm" (click)="confirmarEliminar()">Sí, eliminar</button>
        <button class="btn btn-secondary btn-sm" (click)="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>
-->
<!-- Modal Crear Separación -->
<div class="modal fade" id="modalCrearSeparacion" tabindex="-1" aria-hidden="true"
     [ngClass]="{show: modalCrearVisible}" style="display: block;" *ngIf="modalCrearVisible">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Crear Nueva Separación</h5>
        <button type="button" class="btn-close" (click)="cerrarModal()"></button>
      </div>
<form (ngSubmit)="guardarNuevo()">
  <div class="modal-body row g-3">
    
    <div class="col-12">
      <h6 class="border-bottom pb-2 text-primary"><i class="bi bi-people-fill me-2"></i>Información de Venta</h6>
    </div>

    <div class="col-sm-6">
      <label class="form-label fw-bold">Cliente</label>
      <ng-select
        name="cliente"
        [items]="clientes"
        bindLabel="apellidos"  
        [(ngModel)]="separacionSeleccionada!.cliente"
        [searchFn]="customSearchCliente"
        placeholder="Buscar cliente (DNI o Nombre)..."
        appendTo="body"
        [clearable]="true">
        
        <ng-template ng-label-tmp let-item="item">
           <span class="fw-bold">{{ item.nombre }} {{ item.apellidos }}</span> 
           <small class="ms-2 text-muted">({{ item.numDoc }})</small>
        </ng-template>

        <ng-template ng-option-tmp let-item="item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-person-circle me-1 text-secondary"></i>
              <strong>{{ item.apellidos }}</strong>, {{ item.nombre }}
            </div>
            <span class="badge bg-light text-dark border">{{ item.numDoc }}</span>
          </div>
        </ng-template>
      </ng-select>
    </div>

    <div class="col-sm-6">
      <label class="form-label fw-bold">Vendedor</label>
      <ng-select
        name="vendedor"
        [items]="vendedores"
        bindLabel="apellidos"
        [(ngModel)]="separacionSeleccionada!.vendedor"
        [searchFn]="customSearchVendedor"
        placeholder="Buscar vendedor..."
        appendTo="body">

        <ng-template ng-label-tmp let-item="item">
            {{ item.nombre }} {{ item.apellidos }}
        </ng-template>

        <ng-template ng-option-tmp let-item="item">
           <div class="small">
             <i class="bi bi-person-badge me-1"></i>
             {{ item.nombre }} {{ item.apellidos }}
           </div>
        </ng-template>
      </ng-select>
    </div>

    <div class="col-12 mt-4">
      <h6 class="border-bottom pb-2 text-success"><i class="bi bi-geo-alt-fill me-2"></i>Ubicación del Lote</h6>
    </div>

    <div class="col-sm-6">
      <label class="form-label fw-bold">Programa</label>
      <ng-select
        name="programa"
        [items]="programas"
        bindLabel="nombrePrograma"
        [(ngModel)]="programaSeleccionado"
        (change)="onProgramaChange($event)"
        placeholder="Selecciona Programa"
        appendTo="body">
        
        <ng-template ng-option-tmp let-item="item">
           <div class="d-flex flex-column">
             <span class="fw-bold">{{ item.nombrePrograma }}</span>
             <small class="text-muted" style="font-size: 0.8em;">
               <i class="bi bi-pin-map"></i> {{ item.ubicacion }}
             </small>
           </div>
        </ng-template>
      </ng-select>
    </div>

    <div class="col-sm-6">
      <label class="form-label fw-bold">Lote Disponible</label>
      <ng-select
        name="lote"
        [items]="lotesFiltrados"
        bindLabel="numeroLote"
        [(ngModel)]="separacionSeleccionada!.lote"
        placeholder="Elige un lote..."
        appendTo="body"
        notFoundText="No hay lotes disponibles en este programa">

        <ng-template ng-label-tmp let-item="item">
          Mz. {{ item.manzana }} - Lote {{ item.numeroLote }} ({{ item.area }} m²)
        </ng-template>

        <ng-template ng-option-tmp let-item="item">
          <div class="d-flex justify-content-between">
            <span><strong>Mz. {{ item.manzana }}</strong> - Lote {{ item.numeroLote }}</span>
            <span class="text-success fw-bold">S/. {{ item.precioM2 || '0.00' }}</span>
          </div>
          <small class="text-muted">Área: {{ item.area }} m²</small>
        </ng-template>
      </ng-select>
    </div>

    <div class="col-12 mt-4">
      <h6 class="border-bottom pb-2 text-warning text-dark"><i class="bi bi-cash-stack me-2"></i>Detalles Financieros</h6>
    </div>
    <div class="col-sm-4">
      <label class="form-label">Fecha Separación</label>
      <input type="date" class="form-control" [(ngModel)]="separacionSeleccionada!.fechaSeparacion" name="fechaSeparacion" [value]="fechaActual" required />
    </div>
    <div class="col-sm-4">
      <label class="form-label">Fecha Límite</label>
      <input type="date" class="form-control" [(ngModel)]="separacionSeleccionada!.fechaLimite" name="fechaLimite" [max]="fechaMaxima" required />
    </div>
    <div class="col-sm-4">
      <label class="form-label fw-bold text-success">Monto a Pagar (S/.)</label>
      <div class="input-group">
        <span class="input-group-text">S/.</span>
        <input type="number" class="form-control" [(ngModel)]="separacionSeleccionada!.monto" name="monto" placeholder="0.00" required />
      </div>
    </div>
    <div class="col-sm-12 mt-3">
      <label class="form-label">Observaciones</label>
      <textarea class="form-control" [(ngModel)]="separacionSeleccionada!.observaciones" name="observaciones" rows="2" placeholder="Comentarios adicionales..."></textarea>
    </div>

  </div> 
  <div class="modal-footer bg-light">
    <button type="button" class="btn btn-outline-secondary" (click)="cerrarModal()">Cancelar</button>
    <button type="submit" class="btn btn-success px-4">
      <i class="bi bi-save me-1"></i> Guardar Separación
    </button>
  </div>
</form>

    </div>
  </div>
</div>

  <!-- Paginación -->
  <nav class="mt-3">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <button class="page-link" (click)="previousPage()">Anterior</button>
      </li>
      <li class="page-item" *ngFor="let page of getPagesArray()" [class.active]="page === currentPage">
        <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <button class="page-link" (click)="nextPage()">Siguiente</button>
      </li>
    </ul>
  </nav>
</div>

<!-- Modal Editar Separación -->
<div class="modal fade" id="modalEditarSeparacion" tabindex="-1" aria-hidden="true"
     [ngClass]="{show: modalEditarVisible}" style="display: block;" *ngIf="modalEditarVisible">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar Separación #{{separacionSeleccionada?.idSeparacion}}</h5>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
      </div>

      <form (ngSubmit)="guardarEdicion()">
        <div class="modal-body row g-3">
          
          <div class="col-12">
            <h6 class="border-bottom pb-2 text-primary"><i class="bi bi-people-fill me-2"></i>Información de Venta</h6>
          </div>

          <!-- CLIENTE (Con compareWith) -->
          <div class="col-sm-6">
            <label class="form-label fw-bold">Cliente</label>
            <ng-select
              name="cliente"
              [items]="clientes"
              bindLabel="apellidos"
              [(ngModel)]="separacionSeleccionada!.cliente"
              [compareWith]="compareCliente"
              [searchFn]="customSearchCliente"
              placeholder="Buscar cliente..."
              appendTo="body"
              [clearable]="false"> <!-- No permitir borrar en edición a menos que sea necesario -->
              
              <ng-template ng-label-tmp let-item="item">
                 <span class="fw-bold">{{ item.nombre }} {{ item.apellidos }}</span> 
                 <small class="ms-2 text-muted">({{ item.numDoc }})</small>
              </ng-template>

              <ng-template ng-option-tmp let-item="item">
                <div class="d-flex justify-content-between align-items-center">
                  <div><strong>{{ item.apellidos }}</strong>, {{ item.nombre }}</div>
                  <span class="badge bg-light text-dark border">{{ item.numDoc }}</span>
                </div>
              </ng-template>
            </ng-select>
          </div>

          <!-- VENDEDOR (Con compareWith) -->
          <div class="col-sm-6">
            <label class="form-label fw-bold">Vendedor</label>
            <ng-select
              name="vendedor"
              [items]="vendedores"
              bindLabel="apellidos"
              [(ngModel)]="separacionSeleccionada!.vendedor"
              [compareWith]="compareVendedor"
              [searchFn]="customSearchVendedor"
              placeholder="Buscar vendedor..."
              appendTo="body">

              <ng-template ng-label-tmp let-item="item">
                  {{ item.nombre }} {{ item.apellidos }}
              </ng-template>
            </ng-select>
          </div>

          <!-- NOTA: Bloqueamos Programa y Lote en edición para evitar inconsistencias complejas. 
               Si necesitas cambiarlos, descomenta los selects, pero cuidado con el historial. -->
          <div class="col-12 mt-4">
            <h6 class="border-bottom pb-2 text-success"><i class="bi bi-geo-alt-fill me-2"></i>Ubicación del Lote (Solo Lectura)</h6>
          </div>

          <div class="col-sm-6">
            <label class="form-label text-muted">Programa</label>
            <input type="text" class="form-control bg-light" 
                   [value]="separacionSeleccionada?.lote?.programa?.nombrePrograma" readonly>
          </div>

          <div class="col-sm-6">
            <label class="form-label text-muted">Lote</label>
            <input type="text" class="form-control bg-light" 
                   [value]="'Mz. ' + separacionSeleccionada?.lote?.manzana + ' - Lote ' + separacionSeleccionada?.lote?.numeroLote" readonly>
          </div>

          <div class="col-12 mt-4">
            <h6 class="border-bottom pb-2 text-warning text-dark"><i class="bi bi-cash-stack me-2"></i>Detalles Financieros & Estado</h6>
          </div>

          <div class="col-sm-4">
            <label class="form-label">Fecha Separación</label>
            <input type="date" class="form-control" 
              [ngModel]="separacionSeleccionada!.fechaSeparacion | date:'yyyy-MM-dd'" 
              (ngModelChange)="separacionSeleccionada!.fechaSeparacion = $event"
              name="fechaSeparacion" required />
          </div>

          <div class="col-sm-4">
            <label class="form-label">Fecha Límite</label>
            <input type="date" class="form-control" 
              [ngModel]="separacionSeleccionada!.fechaLimite | date:'yyyy-MM-dd'" 
              (ngModelChange)="separacionSeleccionada!.fechaLimite = $event"
              name="fechaLimite" required />
          </div>

          <div class="col-sm-4">
            <label class="form-label fw-bold text-success">Monto (S/.)</label>
            <div class="input-group">
              <span class="input-group-text">S/.</span>
              <input type="number" class="form-control" [(ngModel)]="separacionSeleccionada!.monto" name="monto" required />
            </div>
          </div>

          <!-- ESTADO (Importante en Edición) -->
          <div class="col-sm-6 mt-3">
             <label class="form-label fw-bold">Estado</label>
             <select class="form-select" [(ngModel)]="separacionSeleccionada!.estado" name="estado">
                <option value="EN_PROCESO">EN PROCESO</option>
                <option value="CONCRETADO">CONCRETADO</option>
                <option value="FINALIZADO">FINALIZADO</option>
             </select>
          </div>

          <div class="col-sm-12 mt-3">
            <label class="form-label">Observaciones</label>
            <textarea class="form-control" [(ngModel)]="separacionSeleccionada!.observaciones" name="observaciones" rows="3"></textarea>
          </div>

        </div> 
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-outline-secondary" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary px-4">
            <i class="bi bi-check-circle me-1"></i> Actualizar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>