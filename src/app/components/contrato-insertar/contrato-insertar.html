<div class="contratos-container">
  <h2>Registro de Contrato</h2>

  <div class="form-wrapper">
    <form [formGroup]="contratoForm" (ngSubmit)="guardarContrato()">

      <div class="form-row form-3-col">
        <div class="form-group">
          <label for="modalidadContrato">Modalidad de Contrato</label>
          <select id="modalidadContrato" formControlName="modalidadContrato">
            <option *ngFor="let modo of modalidadContratoValues" [value]="modo">{{ modo }}</option>
          </select>
        </div>

        <div class="form-group">
          <label for="tipoContrato">Tipo de Contrato</label>
          <select id="tipoContrato" formControlName="tipoContrato">
            <option *ngFor="let tipo of tipoContratoValues" [value]="tipo">{{ tipo }}</option>
          </select>
        </div>

        <div class="form-group">
          <label for="fechaContrato">Fecha del Contrato</label>
          <input type="date" id="fechaContrato" formControlName="fechaContrato" />
        </div>
      </div>

      <div class="form-row form-2-col" *ngIf="contratoForm.get('modalidadContrato')?.value === 'DIRECTO'">
        <div class="form-group">
          <label>Vendedor</label>
          <div class="input-with-button">
            <div class="custom-select-container" #vendedorBusquedaContainer (click)="toggleVendedores()">
              <input type="text" id="vendedorBusqueda" placeholder="Buscar por nombre, apellido o DNI"
                class="custom-select-input" [(ngModel)]="filtroVendedor" (input)="filtrarVendedores()"
                [ngModelOptions]="{standalone: true}" autocomplete="off" />
              <span class="arrow">&#9662;</span>
              <ul class="custom-select-list" *ngIf="mostrarVendedores">
                <li *ngFor="let v of vendedoresFiltrados" (click)="seleccionarVendedor(v)">
                  {{ v.nombre }} {{ v.apellidos }} (DNI: {{ v.dni }})
                </li>
                <li *ngIf="vendedoresFiltrados.length === 0" class="no-data">No se encontraron vendedores</li>
              </ul>
            </div>
            <button type="button" class="btn btn-add-mini" (click)="abrirModalVendedor()">
              <fa-icon [icon]="faPlus"></fa-icon>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>Programa</label>
          <div class="input-with-button">
            <div class="custom-select-container" #programaBusquedaContainer (click)="toggleProgramas()">
              <input type="text" id="programaBusqueda" placeholder="Buscar programa..." class="custom-select-input"
                [(ngModel)]="filtroPrograma" (input)="filtrarProgramas()" [ngModelOptions]="{standalone: true}"
                autocomplete="off" />
              <span class="arrow">&#9662;</span>
              <ul class="custom-select-list" *ngIf="mostrarProgramas">
                <li *ngFor="let prog of programasFiltrados" (click)="seleccionarPrograma(prog)">
                  {{ prog.nombrePrograma }}
                </li>
                <li *ngIf="programasFiltrados.length === 0" class="no-data">No se encontraron programas</li>
              </ul>
            </div>
            <button type="button" class="btn btn-add-mini" (click)="abrirModalPrograma()">
              <fa-icon [icon]="faPlus"></fa-icon>
            </button>
          </div>
        </div>
      </div>

      <div class="form-row" *ngIf="contratoForm.get('modalidadContrato')?.value === 'SEPARACION'">
        <div class="form-group full-width">
          <label>Buscar Separación</label>
          <div class="custom-select-container">
            <input type="text" class="custom-select-input" (input)="buscarSeparaciones($event)"
              placeholder="Buscar por ID, Cliente o Lote..." [(ngModel)]="terminoBusquedaSeparacion"
              [ngModelOptions]="{standalone: true}" autocomplete="off" />

            <span class="arrow">&#9662;</span>

            <ul class="custom-select-list" *ngIf="showSeparacionList && separaciones.length > 0">
              <li *ngFor="let sep of separaciones" (click)="seleccionarSeparacion(sep)">
                <strong>ID: {{ sep.id }}</strong> - {{ sep.text }}
              </li>
            </ul>

            <ul class="custom-select-list"
              *ngIf="showSeparacionList && terminoBusquedaSeparacion && separaciones.length === 0">
              <li class="no-data">No se encontraron registros únicos</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="form-row form-3-col">
        <div class="form-group">
          <label for="montoTotal">Monto Total</label>
          <input type="text" id="montoTotal" formControlName="montoTotal" (focus)="onFocusInput($event, 'montoTotal')"
            (blur)="onCurrencyInput($event, 'montoTotal')" />
        </div>
        <div class="form-group" *ngIf="!esContado">
          <label for="inicial">Inicial</label>
          <input type="text" id="inicial" formControlName="inicial" (focus)="onFocusInput($event, 'inicial')"
            (blur)="onCurrencyInput($event, 'inicial')" />
        </div>
        <div class="form-group" *ngIf="!esContado">
          <label for="saldo">Saldo</label>
          <input type="text" id="saldo" formControlName="saldo" />
        </div>
      </div>

      <div class="form-row form-2-col">
        <div class="form-group" *ngIf="!esContado">
          <label for="cantidadLetras">Cantidad de Letras</label>
          <input type="text" id="cantidadLetras" formControlName="cantidadLetras" />
        </div>
        <div class="form-group">
          <label for="observaciones">Observaciones</label>
          <input type="text" id="observaciones" formControlName="observaciones" />
        </div>
      </div>

      <div class="form-row form-2-col last-form-row" *ngIf="contratoForm.get('modalidadContrato')?.value === 'DIRECTO'">
        <div class="form-group">
          <label>Agregar Cliente</label>
          <div class="input-with-button">
            <div class="custom-select-container" #clienteBusquedaContainer (click)="toggleClientes()">
              <input type="text" placeholder="Buscar por nombre, apellido o DNI" class="custom-select-input"
                [(ngModel)]="filtroCliente" (input)="filtrarClientes()" [ngModelOptions]="{standalone: true}"
                autocomplete="off" />
              <span class="arrow">&#9662;</span>
              <ul class="custom-select-list" *ngIf="mostrarClientes">
                <li *ngFor="let c of clientesFiltrados" (click)="seleccionarCliente(c)">
                  {{ c.nombre }} {{ c.apellidos }} (DNI: {{ c.numDoc }})
                </li>
                <li *ngIf="clientesFiltrados.length === 0" class="no-data">No se encontraron clientes</li>
              </ul>
            </div>
            <button type="button" class="btn btn-add-mini" (click)="abrirModalCliente()">
              <fa-icon [icon]="faPlus"></fa-icon>
            </button>
          </div>
          <ul class="selected-items-list">
            <li *ngFor="let cli of clientesSeleccionados" class="item-pequeno">
              {{ cli.nombre }} {{ cli.apellidos }}
              <button type="button" (click)="eliminarCliente(cli.idCliente)">❌</button>
            </li>
          </ul>
        </div>

        <div class="form-group">
          <label>Agregar Lote</label>
          <div class="input-with-button">
            <div class="custom-select-container" #loteBusquedaContainer (click)="toggleLotes()">
              <input type="text" placeholder="Buscar Manzana o Lote..." class="custom-select-input"
                [(ngModel)]="filtroLote" (input)="filtrarLotes()" [ngModelOptions]="{standalone: true}"
                autocomplete="off" />
              <span class="arrow">&#9662;</span>
              <ul class="custom-select-list" *ngIf="mostrarLotes">
                <li *ngFor="let l of lotesFiltrados" (click)="seleccionarLote(l)">
                  Mz. {{ l.manzana }} - Lt. {{ l.numeroLote }} 
                  <span class="text-muted small">({{ getAbreviatura(l) }})</span>
                </li>
              </ul>
            </div>
            <button type="button" class="btn btn-add-mini"><fa-icon [icon]="faPlus"></fa-icon></button>
          </div>
          <ul class="selected-items-list">
            <li *ngFor="let lote of lotesSeleccionados" class="item-pequeno">
              <div class="info-texto">
                Mz. {{ lote.manzana }} - Lt. {{ lote.numeroLote }} 
                <span class="abreviatura">({{ getAbreviatura(lote) }})</span>
              </div>
              <button type="button" (click)="eliminarLote(lote.idLote)">❌</button>
            </li>
          </ul>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="!contratoForm.valid">
          <i class="bi bi-save"></i> Guardar Contrato
        </button>
        <button type="button" class="btn btn-secondary" (click)="router.navigate(['/secretaria-menu/contratos'])">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<app-vendedor-insertar #vendedorModalContrato (vendedorGuardado)="recargarVendedores()"></app-vendedor-insertar>
<app-cliente-insertar #registroModal (clienteGuardado)="RecargarClientes()"></app-cliente-insertar>
<app-programa-inset-edit #registroModalPrograma (ProgramaGuardado)="RecargarProgramas()"></app-programa-inset-edit>