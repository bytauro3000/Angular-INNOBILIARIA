<div class="contenedor-lotes">
  <h1 id="titPrin" class="mb-4">Gestión de Lotes</h1>

  <!-- Filtros -->
  <div class="filtros row g-2 mb-2">
    <div class="col-sm-3">
      <input type="text" class="form-control form-control-sm" placeholder="Filtrar por manzana..."
             [(ngModel)]="filtroManzana" (input)="filtrarLotes()" />
    </div>

    <div class="col-sm-3">
      <select class="form-select form-select-sm" [(ngModel)]="filtroEstado" (change)="filtrarLotes()">
        <option value="">Todos los estados</option>
        <option *ngFor="let estado of ['Disponible', 'Separado', 'Vendido']" [value]="estado">{{ estado }}</option>
      </select>
    </div>

    <div class="col-sm-3">
      <input type="number" class="form-control form-control-sm" placeholder="Filtrar por precio m²..."
             [(ngModel)]="filtroPrecioM2" (input)="filtrarLotes()" />
    </div>
  </div>


  <!-- Botón Crear -->
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-success btn-sm" (click)="mostrarCrear()">
      <i class="bi bi-plus-lg"></i> Crear lote
    </button>
  </div>

  <!-- Tabla -->
  <div class="table-responsive shadow-sm rounded">
    <table class="table table-sm table-hover align-middle tabla-ajustada">
      <thead class="table-dark">
        <tr>
          <th>Id</th>
          <th>Manzana</th>
          <th>N° Lote</th>
          <th>Área</th>
          <th>Precio/m²</th>
          <th>Programa</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let lote of paginatedLotes">
          <td>{{ lote.idLote }}</td>
          <td>{{ lote.manzana }}</td>
          <td>{{ lote.numeroLote }}</td>
          <td>{{ lote.area }}</td>
          <td>{{ lote.precioM2 | currency:'PEN':'symbol':'1.0-0' }}</td>
          <td>{{ lote.programaNombre }}</td>
          <td>
            <span class="badge"
                  [ngClass]="{
                    'bg-success': lote.estado === 'Disponible',
                    'bg-warning text-dark': lote.estado === 'Separado',
                    'bg-danger': lote.estado === 'Vendido'
                  }">
              {{ lote.estado }}
            </span>
          </td>
          <td>
            <button class="btn btn-outline-info btn-sm me-1" (click)="mostrarDetalle(lote)">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-outline-primary btn-sm me-1" (click)="mostrarEditar(lote)">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" (click)="mostrarEliminar(lote)">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal Editar -->
  <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true"
       [ngClass]="{show: modalEditarVisible}" style="display: block;" *ngIf="modalEditarVisible && loteSeleccionado">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Lote</h5>
          <button type="button" class="btn-close" (click)="cerrarModal()"></button>
        </div>

        <form (ngSubmit)="guardarEdicion()">
          <div class="modal-body row g-2">

            <!-- Campos básicos -->
            <div class="col-sm-4">
              <label class="form-label">Manzana</label>
              <input type="text" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.manzana" name="manzana" required />
            </div>
            <div class="col-sm-4">
              <label class="form-label">N° Lote</label>
              <input type="text" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.numeroLote" name="numeroLote" required />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Área (m²)</label>
              <input type="number" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.area" name="area" required />
            </div>

            <!-- Dimensiones -->
            <div class="col-sm-3">
              <label class="form-label">Largo 1</label>
              <input type="number" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.largo1" name="largo1" />
            </div>
            <div class="col-sm-3">
              <label class="form-label">Largo 2</label>
              <input type="number" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.largo2" name="largo2" />
            </div>
            <div class="col-sm-3">
              <label class="form-label">Ancho 1</label>
              <input type="number" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.ancho1" name="ancho1" />
            </div>
            <div class="col-sm-3">
              <label class="form-label">Ancho 2</label>
              <input type="number" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.ancho2" name="ancho2" />
            </div>

            <!-- Precio -->
            <div class="col-sm-4">
              <label class="form-label">Precio/m²</label>
              <input type="number" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.precioM2" name="precioM2" />
            </div>

            <!-- Colindantes -->
            <div class="col-sm-4">
              <label class="form-label">Colindante Norte</label>
              <input type="text" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.colindanteNorte" name="colindanteNorte" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Colindante Sur</label>
              <input type="text" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.colindanteSur" name="colindanteSur" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Colindante Este</label>
              <input type="text" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.colindanteEste" name="colindanteEste" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Colindante Oeste</label>
              <input type="text" class="form-control form-control-sm"
                     [(ngModel)]="loteSeleccionado.colindanteOeste" name="colindanteOeste" />
            </div>

            <!-- Estado y programa -->
            <div class="col-sm-4">
              <label class="form-label">Estado</label>
              <select class="form-select form-select-sm"
                      [(ngModel)]="loteSeleccionado.estado" name="estado" required>
                <option *ngFor="let estado of ['Disponible','Separado','Vendido']"
                        [value]="estado">{{ estado }}</option>
              </select>
            </div>

            <!-- CORRECCIÓN AQUÍ: Agregado appendTo="body" y compareWith -->
            <div class="col-sm-8">
              <label class="form-label">Programa</label>
              <ng-select class="ng-select-sm"
                         [items]="programas"
                         bindLabel="nombrePrograma"
                         [(ngModel)]="loteSeleccionado.programa"
                         [searchable]="true"
                         name="programa"
                         appendTo="body"
                         [compareWith]="comparePrograma">
              </ng-select>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-success btn-sm">Guardar Cambios</button>
            <button type="button" class="btn btn-secondary btn-sm" (click)="cerrarModal()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <!-- Modal Crear -->
  <div class="modal fade" id="modalCrear" tabindex="-1" aria-hidden="true"
       [ngClass]="{show: modalCrearVisible}" style="display: block;" *ngIf="modalCrearVisible">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Crear Nuevo Lote</h5>
          <button type="button" class="btn-close" (click)="cerrarModal()"></button>
        </div>
        <form (ngSubmit)="guardarNuevo()">
          <div class="modal-body row g-2">
            <!-- Campos básicos -->
            <div class="col-sm-4">
              <label class="form-label">Manzana</label>
              <input type="text" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.manzana" name="manzana" required />
            </div>
            <div class="col-sm-4">
              <label class="form-label">N° Lote</label>
              <input type="text" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.numeroLote" name="numeroLote" required />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Área (m²)</label>
              <input type="number" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.area" name="area" required />
            </div>

            <!-- Dimensiones -->
            <div class="col-sm-3">
              <label class="form-label">Largo 1</label>
              <input type="number" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.largo1" name="largo1" />
            </div>
            <div class="col-sm-3">
              <label class="form-label">Largo 2</label>
              <input type="number" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.largo2" name="largo2" />
            </div>
            <div class="col-sm-3">
              <label class="form-label">Ancho 1</label>
              <input type="number" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.ancho1" name="ancho1" />
            </div>
            <div class="col-sm-3">
              <label class="form-label">Ancho 2</label>
              <input type="number" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.ancho2" name="ancho2" />
            </div>

            <!-- Precio -->
            <div class="col-sm-4">
              <label class="form-label">Precio/m²</label>
              <input type="number" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.precioM2" name="precioM2" />
            </div>

            <!-- Colindantes -->
            <div class="col-sm-4">
              <label class="form-label">Colindante Norte</label>
              <input type="text" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.colindanteNorte" name="colindanteNorte" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Colindante Sur</label>
              <input type="text" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.colindanteSur" name="colindanteSur" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Colindante Este</label>
              <input type="text" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.colindanteEste" name="colindanteEste" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Colindante Oeste</label>
              <input type="text" class="form-control form-control-sm" [(ngModel)]="loteSeleccionado!.colindanteOeste" name="colindanteOeste" />
            </div>

            <!-- Estado y programa -->
            <div class="col-sm-4">
              <label class="form-label">Estado</label>
              <select class="form-select form-select-sm" [(ngModel)]="loteSeleccionado!.estado" name="estado" required>
                <option *ngFor="let estado of ['Disponible','Separado','Vendido']" [value]="estado">{{ estado }}</option>
              </select>
            </div>
            <div class="col-sm-8">
              <label class="form-label">Programa</label>
              <ng-select class="ng-select-sm"
                         [items]="programas"
                         bindLabel="nombrePrograma"
                         [(ngModel)]="loteSeleccionado!.programa"
                         [searchable]="true"
                         name="programa"
                         appendTo="body">
              </ng-select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success btn-sm">Crear</button>
            <button type="button" class="btn btn-secondary btn-sm" (click)="cerrarModal()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Detalle -->
  <div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true"
       [ngClass]="{show: modalDetalleVisible}" style="display: block;" *ngIf="modalDetalleVisible">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detalle del Lote</h5>
          <button type="button" class="btn-close" (click)="cerrarModal()"></button>
        </div>
        <div class="modal-body small row g-2">
          <p class="col-sm-3"><strong>Manzana:</strong> {{ loteSeleccionado?.manzana }}</p>
          <p class="col-sm-3"><strong>N° Lote:</strong> {{ loteSeleccionado?.numeroLote }}</p>
          <p class="col-sm-3"><strong>Área:</strong> {{ loteSeleccionado?.area }} m²</p>
          <p class="col-sm-3"><strong>Precio/m²:</strong> {{ loteSeleccionado?.precioM2 | currency:'PEN':'symbol':'1.0-0' }}</p>

          <p class="col-sm-3"><strong>Largo 1:</strong> {{ loteSeleccionado?.largo1 }}</p>
          <p class="col-sm-3"><strong>Largo 2:</strong> {{ loteSeleccionado?.largo2 }}</p>
          <p class="col-sm-3"><strong>Ancho 1:</strong> {{ loteSeleccionado?.ancho1 }}</p>
          <p class="col-sm-3"><strong>Ancho 2:</strong> {{ loteSeleccionado?.ancho2 }}</p>

          <p class="col-sm-6"><strong>Colindante Norte:</strong> {{ loteSeleccionado?.colindanteNorte }}</p>
          <p class="col-sm-6"><strong>Colindante Sur:</strong> {{ loteSeleccionado?.colindanteSur }}</p>
          <p class="col-sm-6"><strong>Colindante Este:</strong> {{ loteSeleccionado?.colindanteEste }}</p>
          <p class="col-sm-6"><strong>Colindante Oeste:</strong> {{ loteSeleccionado?.colindanteOeste }}</p>

          <p class="col-sm-4"><strong>Estado:</strong> {{ loteSeleccionado?.estado }}</p>
          <p class="col-sm-8"><strong>Programa:</strong> {{ loteSeleccionado?.programa?.nombrePrograma }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" (click)="cerrarModal()">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Controles de paginación -->
  <div class="d-flex justify-content-between align-items-center mt-2">
    <small class="text-muted">
      Página {{ currentPage }} de {{ totalPages }}
    </small>

    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <button class="page-link" (click)="previousPage()">Anterior</button>
        </li>

        <li class="page-item"
            *ngFor="let page of getPagesArray()"
            [class.active]="page === currentPage">
          <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
        </li>

        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <button class="page-link" (click)="nextPage()">Siguiente</button>
        </li>
      </ul>
    </nav>
  </div>
</div>